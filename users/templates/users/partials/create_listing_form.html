<div class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold text-gray-900 mb-6 tracking-wide">Создать объявление</h2>
    
    <form method="post" enctype="multipart/form-data" 
          hx-post="{% url 'users:create_listing' %}"
          hx-encoding="multipart/form-data"
          hx-on::after-request="if(event.detail.successful) htmx.ajax('GET', '{% url 'users:my_listings' %}', {target: '#profile-main-content', swap: 'innerHTML', pushUrl: true})">
        {% csrf_token %}
        
        <div class="space-y-4">
            <!-- Name -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.name.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Category -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.category.label }}</label>
                {{ form.category }}
                {% if form.category.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.category.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Color is now optional -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">
                    {{ form.color.label }} 
                    <span class="text-gray-500 text-xs font-normal">(необязательно)</span>
                </label>
                {{ form.color }}
                {% if form.color.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.color.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.description.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Main Image -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.main_image.label }}</label>
                {{ form.main_image }}
                {% if form.main_image.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.main_image.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Additional Images - now limited to 5 with counter -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">Дополнительные фото (необязательно)</label>
                
                <!-- Hidden input that will hold all selected files -->
                <input type="file" name="additional_images" multiple accept="image/*" 
                       id="additional-images-hidden" style="display: none;">
                
                <!-- Visible button to add photos -->
                <button type="button" 
                        onclick="document.getElementById('additional-images-trigger').click()"
                        class="w-full border-2 border-dashed border-gray-300 hover:border-gray-400 py-3 px-4 text-sm text-gray-600 hover:text-gray-900 transition-colors rounded">
                    + Добавить фото
                </button>
                
                <!-- Trigger input for file selection -->
                <input type="file" multiple accept="image/*" 
                       id="additional-images-trigger" 
                       style="display: none;"
                       onchange="addImages(this)">
                
                <p class="text-xs text-gray-600 mt-2">
                    Можно загрузить до 5 фотографий. 
                    <span id="image-count" class="font-semibold text-blue-600"></span>
                </p>
                
                <!-- Preview container for selected images -->
                <div id="images-preview" class="grid grid-cols-5 gap-2 mt-3"></div>
            </div>

            <!-- Total Stock -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.total_stock.label }}</label>
                {{ form.total_stock }}
                {% if form.total_stock.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.total_stock.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Condition -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.condition.label }}</label>
                {{ form.condition }}
                {% if form.condition.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.condition.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Material -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.material.label }}</label>
                {{ form.material }}
                {% if form.material.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.material.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Brand -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">{{ form.brand.label }}</label>
                {{ form.brand }}
                {% if form.brand.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.brand.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Sizes - Added custom size input and "no size" option -->
            <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">Размеры</label>
                
                <!-- Size options grid -->
                <div class="grid grid-cols-3 gap-2" id="size-options">
                    {% for size in sizes %}
                        {% if size.name == "One Size" %}
                            <!-- Renamed to "Другой размер" with custom input -->
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="size_custom" value="custom" 
                                       id="custom-size-checkbox"
                                       onchange="toggleCustomSizeInput()"
                                       class="border-gray-300 focus:ring-gray-900">
                                <span class="text-sm">Другой размер</span>
                            </label>
                        {% else %}
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="sizes" value="{{ size.id }}"
                                       class="border-gray-300 focus:ring-gray-900 size-checkbox">
                                <span class="text-sm">{{ size.name }}</span>
                            </label>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- No Size button for non-clothing items -->
                <div class="mt-3">
                    <label class="flex items-center space-x-2 bg-gray-100 p-2 rounded">
                        <input type="checkbox" name="no_size" id="no-size-checkbox" 
                               onchange="toggleNoSize()"
                               class="border-gray-300 focus:ring-gray-900">
                        <span class="text-sm font-medium">Нет размера (для товаров без размерной сетки)</span>
                    </label>
                </div>
                
                <!-- Custom size input field -->
                <div id="custom-size-input-container" class="mt-3 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Укажите размер:</label>
                    <input type="text" name="custom_size" id="custom-size-input" 
                           placeholder="Например: 44, M/L, 38-40"
                           class="w-full border border-gray-300 py-2 px-3 text-sm focus:outline-none focus:border-gray-900 rounded">
                    <p class="text-xs text-gray-600 mt-1">Введите размер, который будет сохранён и отображён</p>
                </div>
                
                <p class="text-xs text-gray-600 mt-2">Выберите размеры, укажите другой размер или отметьте "Нет размера"</p>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-4 pt-4">
                <button type="submit" 
                        class="bg-[#2F5959] hover:bg-[#254545] text-white font-semibold py-3 px-6 transition-colors duration-200 text-sm tracking-wide">
                    Создать объявление
                </button>
                <button type="button"
                        hx-get="{% url 'users:profile' %}"
                        hx-target="#main-content"
                        hx-push-url="true"
                        class="border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-900 font-semibold py-3 px-6 transition-colors duration-200 text-sm tracking-wide">
                    Отмена
                </button>
            </div>
        </div>
    </form>
</div>

<script>
let selectedFiles = [];

function addImages(input) {
    const newFiles = Array.from(input.files);
    const countDisplay = document.getElementById('image-count');
    const previewContainer = document.getElementById('images-preview');
    
    // Check if adding new files would exceed the limit
    if (selectedFiles.length + newFiles.length > 5) {
        alert(`Можно загрузить максимум 5 фотографий. У вас уже выбрано ${selectedFiles.length} фото.`);
        input.value = '';
        return;
    }
    
    // Add new files to the array
    newFiles.forEach(file => {
        selectedFiles.push(file);
    });
    
    // Clear the trigger input
    input.value = '';
    
    // Update the hidden input with all files
    updateHiddenInput();
    
    // Update counter
    countDisplay.textContent = `Выбрано: ${selectedFiles.length} из 5`;
    
    // Update preview
    updatePreview();
}

function updateHiddenInput() {
    const hiddenInput = document.getElementById('additional-images-hidden');
    const dataTransfer = new DataTransfer();
    
    selectedFiles.forEach(file => {
        dataTransfer.items.add(file);
    });
    
    hiddenInput.files = dataTransfer.files;
}

function updatePreview() {
    const previewContainer = document.getElementById('images-preview');
    previewContainer.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'relative';
            previewDiv.innerHTML = `
                <img src="${e.target.result}" class="w-full h-20 object-cover rounded border border-gray-300">
                <button type="button" 
                        onclick="removeImage(${index})"
                        class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                    ×
                </button>
            `;
            previewContainer.appendChild(previewDiv);
        };
        
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    updateHiddenInput();
    updatePreview();
    
    const countDisplay = document.getElementById('image-count');
    if (selectedFiles.length > 0) {
        countDisplay.textContent = `Выбрано: ${selectedFiles.length} из 5`;
    } else {
        countDisplay.textContent = '';
    }
}

function toggleCustomSizeInput() {
    const checkbox = document.getElementById('custom-size-checkbox');
    const container = document.getElementById('custom-size-input-container');
    const input = document.getElementById('custom-size-input');
    const noSizeCheckbox = document.getElementById('no-size-checkbox');
    
    if (checkbox.checked) {
        container.classList.remove('hidden');
        input.focus();
        noSizeCheckbox.checked = false;
    } else {
        container.classList.add('hidden');
        input.value = '';
    }
}

function toggleNoSize() {
    const noSizeCheckbox = document.getElementById('no-size-checkbox');
    const sizeCheckboxes = document.querySelectorAll('.size-checkbox');
    const customSizeCheckbox = document.getElementById('custom-size-checkbox');
    const customSizeContainer = document.getElementById('custom-size-input-container');
    const customSizeInput = document.getElementById('custom-size-input');
    
    if (noSizeCheckbox.checked) {
        sizeCheckboxes.forEach(cb => {
            cb.checked = false;
            cb.disabled = true;
        });
        customSizeCheckbox.checked = false;
        customSizeCheckbox.disabled = true;
        customSizeContainer.classList.add('hidden');
        customSizeInput.value = '';
    } else {
        sizeCheckboxes.forEach(cb => {
            cb.disabled = false;
        });
        customSizeCheckbox.disabled = false;
    }
}
</script>
